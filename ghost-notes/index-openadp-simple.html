<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>👻🔐 OpenADP Ghost Notes</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="screen active">
        <div class="ghost-container">
            <div class="ghost-logo">👻🔐</div>
            <h1>OpenADP Ghost Notes</h1>
            <p class="tagline">Your notes protected by distributed cryptography</p>
            
            <div class="openadp-status">
                <div class="openadp-indicator">
                    <span class="status-dot"></span>
                    <span>Protected by OpenADP Distributed Secret Sharing</span>
                </div>
                <div class="security-level">
                    🛡️ Even simple PINs become cryptographically strong
                </div>
            </div>
            
            <div class="pin-entry">
                <input type="password" id="pin-input" placeholder="Enter your PIN" maxlength="20">
                <div id="attempts-remaining" class="attempts-remaining">10 attempts remaining</div>
                <div id="error-message" class="error-message"></div>
            </div>
            
            <button id="unlock-btn" class="unlock-btn">🔓 Unlock Notes</button>
            
            <div class="setup-options">
                <button id="setup-btn" class="setup-btn">⚙️ First Time Setup</button>
            </div>
            
            <div class="openadp-info">
                <details>
                    <summary>🔍 How OpenADP Transforms PIN Security</summary>
                    <div class="info-content">
                        <p><strong>Traditional Problem:</strong> A 4-digit PIN can be brute-forced in seconds</p>
                        <p><strong>OpenADP Solution:</strong> Distributed secret sharing makes any PIN cryptographically strong</p>
                        <ul>
                            <li>🌐 Secret split across multiple independent servers</li>
                            <li>🎯 Requires majority of servers to recover</li>
                            <li>🛡️ No single point of failure</li>
                            <li>⚡ Offline attacks impossible</li>
                        </ul>
                        <p><em>Same user experience, military-grade security!</em></p>
                    </div>
                </details>
            </div>
        </div>
    </div>

    <!-- Setup Screen -->
    <div id="setup-screen" class="screen">
        <div class="setup-container">
            <h2>🔐 Setup Your Secure Notes</h2>
            <p>Create a PIN that will be protected by distributed cryptography</p>
            
            <div class="setup-form">
                <div class="form-group">
                    <label for="setup-pin">Create PIN:</label>
                    <input type="password" id="setup-pin" placeholder="Enter a PIN (any length)">
                    <small>With OpenADP, even "1234" becomes cryptographically strong!</small>
                </div>
                
                <div class="form-group">
                    <label for="confirm-pin">Confirm PIN:</label>
                    <input type="password" id="confirm-pin" placeholder="Confirm your PIN">
                </div>
                
                <button id="create-vault-btn" class="create-btn">🛡️ Create Secure Vault</button>
                <button id="cancel-setup-btn" class="cancel-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Main App Screen -->
    <div id="app-screen" class="screen">
        <header class="app-header">
            <h1>👻🔐 OpenADP Ghost Notes</h1>
            <div class="session-info">
                <div class="openadp-status-mini">
                    <span class="status-dot active"></span>
                    <span>OpenADP Protected</span>
                </div>
                <button id="lock-now-btn" class="lock-now-btn">🔒 Lock Now</button>
            </div>
        </header>
        
        <main class="app-main">
            <aside class="notes-sidebar">
                <div class="sidebar-header">
                    <h2>Notes</h2>
                    <button id="new-note-btn" class="new-note-btn">➕</button>
                </div>
                <div id="notes-list" class="notes-list">
                    <!-- Notes list will be populated here -->
                </div>
            </aside>
            
            <section class="note-editor-container">
                <div id="welcome-message" class="welcome-message">
                    <div class="welcome-icon">📝🔐</div>
                    <h3>Welcome to OpenADP Ghost Notes</h3>
                    <p>Your notes are protected by distributed cryptography!</p>
                    <div class="security-badges">
                        <span class="badge">🌐 Distributed</span>
                        <span class="badge">🎯 Threshold</span>
                        <span class="badge">🛡️ Secure</span>
                        <span class="badge">👻 Ghost</span>
                    </div>
                </div>
                
                <div id="note-editor" class="note-editor" style="display: none;">
                    <div class="editor-header">
                        <input type="text" id="note-title" class="note-title" placeholder="Note title...">
                        <div class="editor-actions">
                            <button id="save-note-btn" class="save-btn">💾 Save</button>
                            <button id="delete-note-btn" class="delete-btn">🗑️ Delete</button>
                        </div>
                    </div>
                    <textarea id="note-content" class="note-content" placeholder="Start writing your secret thoughts...

Your notes are protected by OpenADP distributed cryptography:
• Even simple PINs become cryptographically strong
• No single point of failure
• Offline attacks impossible
• Session vanishes when you lock

Write freely knowing your secrets are truly secure! 🚀"></textarea>
                    <div class="note-metadata">
                        <span id="note-created">Created: --</span>
                        <span id="note-modified">Modified: --</span>
                        <span class="security-indicator">🔐 OpenADP Protected</span>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Connecting to OpenADP...</div>
            <div class="loading-details">
                📡 Contacting distributed servers...<br>
                🔐 Protecting your PIN...<br>
                🛡️ Establishing secure session...
            </div>
        </div>
    </div>

    <script type="module">
        // Import the high-level ocrypt APIs - much simpler!
        import { register, recover, OcryptError } from '../sdk/browser-javascript/ocrypt.js';
        
        class OpenADPGhostNotes {
            constructor() {
                this.currentScreen = 'login';
                this.notesData = null;  // Decrypted notes in memory only
                this.currentNoteId = null;
                this.userID = this.getUserID();
                this.appID = 'ghost-notes';
                
                this.init();
            }

            async init() {
                console.log('👻🔐 OpenADP Ghost Notes - Using Ocrypt APIs');
                
                // Check if vault exists
                const hasVault = localStorage.getItem('ghost_vault_metadata') !== null;
                
                if (!hasVault) {
                    this.showScreen('setup');
                } else {
                    this.showScreen('login');
                    this.updateAttemptsDisplay();
                }
                
                this.setupEventListeners();
            }

            getUserID() {
                let userID = localStorage.getItem('ghost_user_id');
                if (!userID) {
                    userID = 'ghost-' + crypto.randomUUID();
                    localStorage.setItem('ghost_user_id', userID);
                }
                return userID;
            }

            showScreen(screenName) {
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.remove('active');
                });
                document.getElementById(`${screenName}-screen`).classList.add('active');
                this.currentScreen = screenName;
            }

            setupEventListeners() {
                // Login
                document.getElementById('unlock-btn').addEventListener('click', () => this.handleUnlock());
                document.getElementById('pin-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.handleUnlock();
                });
                document.getElementById('setup-btn').addEventListener('click', () => this.showScreen('setup'));
                
                // Setup
                document.getElementById('create-vault-btn').addEventListener('click', () => this.handleSetup());
                document.getElementById('cancel-setup-btn').addEventListener('click', () => this.showScreen('login'));
                
                // App
                document.getElementById('lock-now-btn').addEventListener('click', () => this.lockSession());
                document.getElementById('new-note-btn').addEventListener('click', () => this.createNewNote());
                document.getElementById('save-note-btn').addEventListener('click', () => this.saveCurrentNote());
                document.getElementById('delete-note-btn').addEventListener('click', () => this.deleteCurrentNote());
                
                // Auto-save
                document.getElementById('note-title').addEventListener('input', () => this.autoSave());
                document.getElementById('note-content').addEventListener('input', () => this.autoSave());
            }

            async handleSetup() {
                const pin = document.getElementById('setup-pin').value;
                const confirmPin = document.getElementById('confirm-pin').value;
                
                if (!pin || pin.length < 1) {
                    this.showError('Please enter a PIN');
                    return;
                }
                
                if (pin !== confirmPin) {
                    this.showError('PINs do not match');
                    return;
                }
                
                try {
                    this.showLoading('Creating OpenADP vault...');
                    
                    // Create initial notes data structure
                    const initialNotes = {
                        welcome: {
                            id: 'welcome',
                            title: '👻 Welcome to OpenADP Ghost Notes',
                            content: `Welcome! Your notes are now protected by OpenADP distributed cryptography.

🔐 **How it works:**
Your PIN ("${pin}") is now protected by distributed secret sharing across multiple servers. Even this simple PIN is now cryptographically strong!

🛡️ **Security Features:**
• No single point of failure
• Offline attacks impossible  
• Automatic backup refresh
• Session-based security

📝 **Usage:**
• Click ➕ to create new notes
• Notes auto-save as you type
• Everything vanishes when you lock
• Perfect for sensitive information

Start writing - your secrets are truly secure! ✨`,
                            created: new Date().toISOString(),
                            modified: new Date().toISOString()
                        }
                    };
                    
                    // Convert notes to bytes
                    const notesJSON = JSON.stringify(initialNotes);
                    const notesBytes = new TextEncoder().encode(notesJSON);
                    
                    console.log(`🔐 Protecting ${notesBytes.length} bytes with PIN "${pin}"`);
                    
                    // Use ocrypt to protect the notes with the PIN - this is it!
                    const metadata = await register(
                        this.userID,    // User identifier  
                        this.appID,     // App identifier
                        notesBytes,     // The secret data to protect
                        pin,            // The PIN that unlocks it
                        10              // Max wrong attempts
                    );
                    
                    // Store the metadata (safe to store anywhere)
                    localStorage.setItem('ghost_vault_metadata', Array.from(metadata).join(','));
                    
                    this.hideLoading();
                    this.showScreen('login');
                    this.showMessage('✅ OpenADP vault created! Your PIN is now cryptographically strong.');
                    
                    console.log('✅ Vault created with ocrypt API');
                    
                } catch (error) {
                    this.hideLoading();
                    console.error('Setup failed:', error);
                    this.showError(`Setup failed: ${error.message}`);
                }
            }

            async handleUnlock() {
                const pin = document.getElementById('pin-input').value;
                if (!pin) {
                    this.showError('Please enter your PIN');
                    return;
                }
                
                try {
                    this.showLoading('Unlocking with OpenADP...');
                    
                    // Get stored metadata
                    const metadataStr = localStorage.getItem('ghost_vault_metadata');
                    if (!metadataStr) {
                        throw new Error('No vault found. Please set up first.');
                    }
                    
                    const metadata = new Uint8Array(metadataStr.split(',').map(x => parseInt(x)));
                    
                    console.log(`🔐 Recovering notes with PIN "${pin}"`);
                    
                    // Use ocrypt to recover the notes - this is it!
                    const { secret, remaining, updatedMetadata } = await recover(metadata, pin);
                    
                    // Update metadata if it was refreshed
                    if (updatedMetadata !== metadata) {
                        localStorage.setItem('ghost_vault_metadata', Array.from(updatedMetadata).join(','));
                        console.log('📝 Metadata refreshed automatically');
                    }
                    
                    // Parse recovered notes
                    const notesJSON = new TextDecoder().decode(secret);
                    this.notesData = JSON.parse(notesJSON);
                    
                    console.log(`✅ Recovered ${Object.keys(this.notesData).length} notes`);
                    console.log(`📊 Remaining attempts: ${remaining}`);
                    
                    this.hideLoading();
                    this.startSession();
                    
                } catch (error) {
                    this.hideLoading();
                    console.error('Unlock failed:', error);
                    this.showError(`Unlock failed: ${error.message}`);
                    document.getElementById('pin-input').value = '';
                }
            }

            startSession() {
                this.showScreen('app');
                this.updateNotesListUI();
                console.log('👻 Session started - notes loaded into memory');
            }

            async saveNotesToVault() {
                if (!this.notesData) return;
                
                try {
                    // Get current PIN (in real app, you'd need to ask user or cache securely)
                    const pin = document.getElementById('pin-input').value || 
                              prompt('Enter your PIN to save:');
                    if (!pin) return;
                    
                    // Convert notes to bytes
                    const notesJSON = JSON.stringify(this.notesData);
                    const notesBytes = new TextEncoder().encode(notesJSON);
                    
                    // Get current metadata
                    const metadataStr = localStorage.getItem('ghost_vault_metadata');
                    const metadata = new Uint8Array(metadataStr.split(',').map(x => parseInt(x)));
                    
                    // Recover and re-register to update the vault
                    const { secret, remaining, updatedMetadata } = await recover(metadata, pin);
                    
                    // Now register the new notes data
                    const newMetadata = await register(
                        this.userID,
                        this.appID,
                        notesBytes,
                        pin,
                        10
                    );
                    
                    localStorage.setItem('ghost_vault_metadata', Array.from(newMetadata).join(','));
                    console.log('💾 Notes saved to OpenADP vault');
                    
                } catch (error) {
                    console.error('Failed to save to vault:', error);
                    this.showError('Failed to save notes to vault');
                }
            }

            lockSession() {
                // Clear sensitive data from memory
                this.notesData = null;
                this.currentNoteId = null;
                
                // Clear UI
                this.clearNotesUI();
                document.getElementById('pin-input').value = '';
                
                this.showScreen('login');
                console.log('🔒 Session locked - all data cleared from memory');
            }

            createNewNote() {
                if (!this.notesData) return;
                
                const id = Date.now().toString();
                const newNote = {
                    id: id,
                    title: 'New Note',
                    content: '',
                    created: new Date().toISOString(),
                    modified: new Date().toISOString()
                };
                
                this.notesData[id] = newNote;
                this.selectNote(id);
                this.updateNotesListUI();
                
                // Focus on title
                setTimeout(() => {
                    document.getElementById('note-title').focus();
                    document.getElementById('note-title').select();
                }, 100);
            }

            selectNote(noteId) {
                if (!this.notesData || !this.notesData[noteId]) return;
                
                const note = this.notesData[noteId];
                this.currentNoteId = noteId;
                
                document.getElementById('note-title').value = note.title;
                document.getElementById('note-content').value = note.content;
                document.getElementById('note-created').textContent = `Created: ${new Date(note.created).toLocaleString()}`;
                document.getElementById('note-modified').textContent = `Modified: ${new Date(note.modified).toLocaleString()}`;
                
                document.getElementById('welcome-message').style.display = 'none';
                document.getElementById('note-editor').style.display = 'block';
                
                // Update sidebar
                document.querySelectorAll('.note-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector(`[data-note-id="${noteId}"]`)?.classList.add('active');
            }

            saveCurrentNote() {
                if (!this.currentNoteId || !this.notesData) return;
                
                const note = this.notesData[this.currentNoteId];
                note.title = document.getElementById('note-title').value || 'Untitled';
                note.content = document.getElementById('note-content').value;
                note.modified = new Date().toISOString();
                
                this.updateNotesListUI();
                document.getElementById('note-modified').textContent = `Modified: ${new Date(note.modified).toLocaleString()}`;
                
                this.showMessage('💾 Note saved in memory (auto-protected by OpenADP)');
                
                // Optionally save to vault immediately
                // this.saveNotesToVault();
            }

            autoSave() {
                if (!this.currentNoteId) return;
                
                if (this.autoSaveTimer) {
                    clearTimeout(this.autoSaveTimer);
                }
                
                this.autoSaveTimer = setTimeout(() => {
                    this.saveCurrentNote();
                }, 1000);
            }

            deleteCurrentNote() {
                if (!this.currentNoteId || !this.notesData) return;
                
                if (confirm('Delete this note? This cannot be undone.')) {
                    delete this.notesData[this.currentNoteId];
                    this.currentNoteId = null;
                    
                    document.getElementById('welcome-message').style.display = 'block';
                    document.getElementById('note-editor').style.display = 'none';
                    
                    this.updateNotesListUI();
                    this.showMessage('🗑️ Note deleted');
                }
            }

            updateNotesListUI() {
                const notesList = document.getElementById('notes-list');
                notesList.innerHTML = '';
                
                if (!this.notesData) return;
                
                // Sort by modified date
                const notes = Object.values(this.notesData)
                    .sort((a, b) => new Date(b.modified) - new Date(a.modified));
                
                for (const note of notes) {
                    const noteItem = document.createElement('div');
                    noteItem.className = 'note-item';
                    noteItem.dataset.noteId = note.id;
                    
                    const preview = note.content.substring(0, 80) + (note.content.length > 80 ? '...' : '');
                    
                    noteItem.innerHTML = `
                        <div class="note-title">${note.title}</div>
                        <div class="note-preview">${preview}</div>
                        <div class="note-date">${new Date(note.modified).toLocaleDateString()}</div>
                        <div class="note-security">🔐 OpenADP</div>
                    `;
                    
                    noteItem.addEventListener('click', () => this.selectNote(note.id));
                    notesList.appendChild(noteItem);
                }
            }

            clearNotesUI() {
                document.getElementById('notes-list').innerHTML = '';
                document.getElementById('welcome-message').style.display = 'block';
                document.getElementById('note-editor').style.display = 'none';
            }

            updateAttemptsDisplay() {
                // In a real app, you might parse this from last error or store separately
                document.getElementById('attempts-remaining').textContent = '10 attempts remaining';
            }

            showLoading(message) {
                document.querySelector('.loading-text').textContent = message;
                document.getElementById('loading-overlay').style.display = 'flex';
            }

            hideLoading() {
                document.getElementById('loading-overlay').style.display = 'none';
            }

            showError(message) {
                const errorEl = document.getElementById('error-message');
                errorEl.textContent = message;
                errorEl.style.display = 'block';
                setTimeout(() => errorEl.style.display = 'none', 5000);
            }

            showMessage(message) {
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed; top: 20px; right: 20px; background: #4ecdc4;
                    color: white; padding: 1rem; border-radius: 8px; z-index: 3000;
                `;
                toast.textContent = message;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }
        }

        // Start the app
        document.addEventListener('DOMContentLoaded', () => {
            window.ghostNotes = new OpenADPGhostNotes();
        });
    </script>

    <!-- OpenADP-specific styles -->
    <style>
        .openadp-status {
            margin: 1rem 0; padding: 1rem;
            background: linear-gradient(135deg, rgba(74, 144, 226, 0.1), rgba(74, 144, 226, 0.05));
            border: 1px solid rgba(74, 144, 226, 0.3); border-radius: 8px;
        }
        .openadp-indicator {
            display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;
        }
        .status-dot {
            width: 8px; height: 8px; border-radius: 50%; background: #4ecdc4;
            animation: pulse 2s infinite;
        }
        .status-dot.active { background: #00ff88; }
        .security-level { font-size: 0.9rem; color: #4a90e2; }
        .openadp-info { margin-top: 1rem; }
        .openadp-info details { background: #2a2a2a; border-radius: 8px; padding: 0.5rem; }
        .openadp-info summary { cursor: pointer; padding: 0.5rem; font-weight: bold; color: #4a90e2; }
        .info-content { padding: 1rem; font-size: 0.9rem; line-height: 1.4; }
        .info-content ul { margin: 0.5rem 0; padding-left: 1.5rem; }
        .openadp-status-mini { display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; }
        .security-badges { display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap; }
        .badge { background: #4a90e2; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem; font-weight: bold; }
        .security-indicator { color: #4ecdc4; font-weight: bold; }
        .form-group small { display: block; margin-top: 0.25rem; color: #4a90e2; font-size: 0.8rem; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</body>
</html> 