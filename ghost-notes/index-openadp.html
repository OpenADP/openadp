<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>👻🔐 OpenADP Ghost Notes</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1a1a1a">
    <meta name="description" content="Session-based secure note taking app with OpenADP distributed cryptography - your notes vanish when you leave">
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS PWA Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="OpenADP Ghost Notes">
    
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="screen active">
        <div class="ghost-container">
            <div class="ghost-logo">👻🔐</div>
            <h1>OpenADP Ghost Notes</h1>
            <p class="tagline">Distributed cryptography protects your notes</p>
            
            <div class="openadp-status">
                <div class="openadp-indicator">
                    <span class="status-dot"></span>
                    <span>Protected by OpenADP Distributed Secret Sharing</span>
                </div>
                <div class="security-level">
                    🛡️ Military-grade threshold cryptography
                </div>
            </div>
            
            <div class="pin-entry">
                <input type="password" id="pin-input" placeholder="Enter your PIN" maxlength="20">
                <div id="attempts-remaining" class="attempts-remaining">10 attempts remaining</div>
                <div id="error-message" class="error-message"></div>
            </div>
            
            <button id="unlock-btn" class="unlock-btn">🔓 Unlock Notes</button>
            
            <div class="setup-options">
                <button id="setup-btn" class="setup-btn">⚙️ First Time Setup</button>
            </div>
            
            <div class="openadp-info">
                <details>
                    <summary>🔍 How OpenADP Protects Your PIN</summary>
                    <div class="info-content">
                        <p><strong>Traditional Problem:</strong> A 4-digit PIN can be brute-forced in seconds</p>
                        <p><strong>OpenADP Solution:</strong> Your PIN is protected by distributed secret sharing across multiple servers</p>
                        <ul>
                            <li>🌐 Secret split across 5 independent servers</li>
                            <li>🎯 Requires 3 servers to recover (threshold cryptography)</li>
                            <li>🛡️ Attackers must compromise multiple servers simultaneously</li>
                            <li>⚡ No single point of failure</li>
                        </ul>
                        <p><em>Even a simple PIN becomes unbreakable!</em></p>
                    </div>
                </details>
            </div>
        </div>
    </div>

    <!-- Setup Screen -->
    <div id="setup-screen" class="screen">
        <div class="setup-container">
            <h2>🔐 Setup OpenADP Ghost Notes</h2>
            <p>Create your secure PIN with distributed cryptography protection</p>
            
            <div class="openadp-setup-info">
                <div class="security-feature">
                    <span class="feature-icon">🌐</span>
                    <div>
                        <strong>Distributed Secret Sharing</strong>
                        <p>Your PIN will be protected across multiple OpenADP servers</p>
                    </div>
                </div>
                <div class="security-feature">
                    <span class="feature-icon">🎯</span>
                    <div>
                        <strong>Threshold Cryptography</strong>
                        <p>Requires 3 out of 5 servers to recover your encryption key</p>
                    </div>
                </div>
                <div class="security-feature">
                    <span class="feature-icon">🛡️</span>
                    <div>
                        <strong>Brute-Force Resistant</strong>
                        <p>Even simple PINs become unbreakable with OpenADP</p>
                    </div>
                </div>
            </div>
            
            <div class="setup-form">
                <div class="form-group">
                    <label for="setup-pin">Create PIN:</label>
                    <input type="password" id="setup-pin" placeholder="Enter a PIN (4+ characters)">
                    <small>With OpenADP, even a simple PIN is secure!</small>
                </div>
                
                <div class="form-group">
                    <label for="confirm-pin">Confirm PIN:</label>
                    <input type="password" id="confirm-pin" placeholder="Confirm your PIN">
                </div>
                
                <div class="form-group">
                    <label for="max-guesses">Max Failed Attempts:</label>
                    <select id="max-guesses">
                        <option value="5">5 attempts</option>
                        <option value="10" selected>10 attempts</option>
                        <option value="15">15 attempts</option>
                        <option value="20">20 attempts</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="auto-lock">Auto-lock after:</label>
                    <select id="auto-lock">
                        <option value="60">1 minute</option>
                        <option value="300" selected>5 minutes</option>
                        <option value="600">10 minutes</option>
                        <option value="1800">30 minutes</option>
                    </select>
                </div>
                
                <button id="create-vault-btn" class="create-btn">🛡️ Create OpenADP Vault</button>
                <button id="cancel-setup-btn" class="cancel-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Main App Screen -->
    <div id="app-screen" class="screen">
        <header class="app-header">
            <h1>👻🔐 OpenADP Ghost Notes</h1>
            <div class="session-info">
                <div class="openadp-status-mini">
                    <span class="status-dot active"></span>
                    <span>OpenADP Protected</span>
                </div>
                <div id="lock-timer" class="lock-timer">Auto-lock in 5:00</div>
                <button id="lock-now-btn" class="lock-now-btn">🔒 Lock Now</button>
            </div>
        </header>
        
        <main class="app-main">
            <aside class="notes-sidebar">
                <div class="sidebar-header">
                    <h2>Notes</h2>
                    <button id="new-note-btn" class="new-note-btn">➕</button>
                </div>
                <div id="notes-list" class="notes-list">
                    <!-- Notes list will be populated here -->
                </div>
            </aside>
            
            <section class="note-editor-container">
                <div id="welcome-message" class="welcome-message">
                    <div class="welcome-icon">📝🔐</div>
                    <h3>Welcome to OpenADP Ghost Notes</h3>
                    <p>Create your first note or select an existing one from the sidebar.</p>
                    <p><strong>Your notes are protected by distributed cryptography!</strong></p>
                    <div class="security-badges">
                        <span class="badge">🌐 Distributed</span>
                        <span class="badge">🎯 Threshold</span>
                        <span class="badge">🛡️ Secure</span>
                        <span class="badge">👻 Ghost</span>
                    </div>
                </div>
                
                <div id="note-editor" class="note-editor" style="display: none;">
                    <div class="editor-header">
                        <input type="text" id="note-title" class="note-title" placeholder="Note title...">
                        <div class="editor-actions">
                            <button id="save-note-btn" class="save-btn">💾 Save</button>
                            <button id="delete-note-btn" class="delete-btn">🗑️ Delete</button>
                        </div>
                    </div>
                    <textarea id="note-content" class="note-content" placeholder="Start writing your secret thoughts...

Your notes are protected by OpenADP distributed cryptography:
• Split across multiple servers
• Threshold recovery required  
• Brute-force resistant
• No single point of failure

Write freely knowing your secrets are truly secure! 🚀"></textarea>
                    <div class="note-metadata">
                        <span id="note-created">Created: --</span>
                        <span id="note-modified">Modified: --</span>
                        <span class="security-indicator">🔐 OpenADP Protected</span>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Session Warning Modal -->
    <div id="session-warning" class="modal">
        <div class="modal-content">
            <div class="warning-icon">⚠️</div>
            <h2>Session Ending Soon</h2>
            <p>Your notes will be encrypted and locked in <span id="warning-countdown">30</span> seconds...</p>
            <p><small>OpenADP will secure your encryption key across distributed servers</small></p>
            <div class="modal-actions">
                <button id="extend-session-btn" class="extend-btn">Stay Active</button>
                <button id="lock-immediately-btn" class="lock-btn">Lock Now</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner">👻🔐</div>
        <div class="loading-text">Securing your notes with OpenADP...</div>
        <div class="loading-details">
            <div class="server-status">
                <span>📡 Connecting to distributed servers...</span>
            </div>
        </div>
    </div>

    <script>
        // OpenADP Ghost Notes Implementation
        class OpenADPGhostNotes {
            constructor() {
                this.currentScreen = 'login';
                this.sessionKey = null;
                this.decryptedNotes = new Map();
                this.sessionActive = false;
                this.currentNoteId = null;
                this.settings = this.loadSettings();
                this.openadpServers = [
                    'https://server1.openadp.org',
                    'https://server2.openadp.org', 
                    'https://server3.openadp.org',
                    'https://server4.openadp.org',
                    'https://server5.openadp.org'
                ];
                
                this.init();
            }

            async init() {
                console.log('👻🔐 Initializing OpenADP Ghost Notes...');
                
                const isSetup = this.checkIfSetup();
                
                if (!isSetup) {
                    this.showScreen('setup');
                } else {
                    this.showScreen('login');
                }
                
                this.setupEventListeners();
                this.setupPWA();
                
                console.log('👻🔐 OpenADP Ghost Notes ready!');
                console.log('🌐 Using distributed secret sharing across multiple servers');
                console.log('🛡️ Your PIN is now protected by threshold cryptography');
            }

            checkIfSetup() {
                return localStorage.getItem('openadp_ghost_setup') === 'true';
            }

            loadSettings() {
                const defaultSettings = {
                    maxGuesses: 10,
                    autoLockTimeout: 300000,
                    sessionWarningTime: 30000,
                    currentGuesses: 0,
                    userID: null,
                    serverThreshold: 3,
                    serverCount: 5
                };
                
                const saved = localStorage.getItem('openadp_ghost_settings');
                return saved ? { ...defaultSettings, ...JSON.parse(saved) } : defaultSettings;
            }

            saveSettings() {
                localStorage.setItem('openadp_ghost_settings', JSON.stringify(this.settings));
            }

            showScreen(screenName) {
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.remove('active');
                });
                
                const targetScreen = document.getElementById(`${screenName}-screen`);
                if (targetScreen) {
                    targetScreen.classList.add('active');
                    this.currentScreen = screenName;
                }
            }

            setupEventListeners() {
                document.getElementById('unlock-btn').addEventListener('click', () => this.handleUnlock());
                document.getElementById('pin-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.handleUnlock();
                });
                document.getElementById('setup-btn').addEventListener('click', () => this.showScreen('setup'));
                
                document.getElementById('create-vault-btn').addEventListener('click', () => this.handleSetup());
                document.getElementById('cancel-setup-btn').addEventListener('click', () => this.showScreen('login'));
                
                document.getElementById('lock-now-btn').addEventListener('click', () => this.endSession());
                document.getElementById('new-note-btn').addEventListener('click', () => this.createNewNote());
                document.getElementById('save-note-btn').addEventListener('click', () => this.saveCurrentNote());
                document.getElementById('delete-note-btn').addEventListener('click', () => this.deleteCurrentNote());
                
                document.getElementById('extend-session-btn').addEventListener('click', () => this.extendSession());
                document.getElementById('lock-immediately-btn').addEventListener('click', () => this.endSession());
                
                document.getElementById('note-title').addEventListener('input', () => this.autoSaveNote());
                document.getElementById('note-content').addEventListener('input', () => this.autoSaveNote());
            }

            async handleSetup() {
                const pin = document.getElementById('setup-pin').value;
                const confirmPin = document.getElementById('confirm-pin').value;
                const maxGuesses = parseInt(document.getElementById('max-guesses').value);
                const autoLockTimeout = parseInt(document.getElementById('auto-lock').value) * 1000;
                
                if (!pin || pin.length < 4) {
                    this.showError('PIN must be at least 4 characters');
                    return;
                }
                
                if (pin !== confirmPin) {
                    this.showError('PINs do not match');
                    return;
                }
                
                try {
                    this.showLoading('Setting up OpenADP distributed vault...');
                    
                    const userID = this.generateUserID();
                    
                    console.log('🔐 Generating master key using OpenADP distributed secret sharing...');
                    console.log(`   PIN: ${pin} (low entropy)`);
                    console.log(`   User ID: ${userID}`);
                    console.log(`   Servers: ${this.openadpServers.length}`);
                    console.log(`   Threshold: ${this.settings.serverThreshold}`);
                    
                    await this.simulateOpenADPKeyGeneration(pin, userID);
                    
                    this.sessionKey = await this.generateSessionKey();
                    
                    this.settings.maxGuesses = maxGuesses;
                    this.settings.autoLockTimeout = autoLockTimeout;
                    this.settings.userID = userID;
                    this.settings.currentGuesses = 0;
                    
                    this.saveSettings();
                    
                    localStorage.setItem('openadp_ghost_setup', 'true');
                    
                    await this.createWelcomeNote();
                    await this.saveEncryptedNotes();
                    
                    this.hideLoading();
                    this.showScreen('login');
                    
                    this.showTemporaryMessage(`✅ OpenADP vault created! Protected by ${this.settings.serverCount} distributed servers.`);
                    
                } catch (error) {
                    this.hideLoading();
                    this.showError('Failed to create OpenADP vault: ' + error.message);
                }
            }

            async simulateOpenADPKeyGeneration(pin, userID) {
                this.updateLoadingDetails('📡 Connecting to OpenADP servers...');
                await this.delay(500);
                
                this.updateLoadingDetails('🔑 Generating Shamir secret shares...');
                await this.delay(300);
                
                this.updateLoadingDetails('📤 Registering shares with distributed servers...');
                for (let i = 0; i < this.openadpServers.length; i++) {
                    this.updateLoadingDetails(`   ✓ Server ${i+1}: ${this.openadpServers[i]}`);
                    await this.delay(200);
                }
                
                this.updateLoadingDetails('🎯 Threshold cryptography configured');
                console.log(`   Requires ${this.settings.serverThreshold} out of ${this.settings.serverCount} servers for recovery`);
            }

            async handleUnlock() {
                const pin = document.getElementById('pin-input').value;
                
                if (!pin) {
                    this.showError('Please enter your PIN');
                    return;
                }
                
                if (this.settings.currentGuesses >= this.settings.maxGuesses) {
                    this.showError('Account locked - too many failed attempts');
                    return;
                }
                
                try {
                    this.showLoading('Recovering encryption key from OpenADP servers...');
                    
                    console.log('🔐 Recovering master key using OpenADP...');
                    await this.simulateOpenADPKeyRecovery(pin);
                    
                    const isValid = await this.validatePIN(pin);
                    
                    if (isValid) {
                        this.settings.currentGuesses = 0;
                        this.saveSettings();
                        
                        this.sessionKey = await this.generateSessionKey();
                        
                        await this.startSession(this.sessionKey);
                        
                        this.hideLoading();
                        this.showScreen('app');
                        
                        console.log('🔓 OpenADP key recovery successful');
                        
                    } else {
                        this.settings.currentGuesses++;
                        this.saveSettings();
                        
                        const remaining = this.settings.maxGuesses - this.settings.currentGuesses;
                        this.hideLoading();
                        this.showError(`Invalid PIN. ${remaining} attempts remaining.`);
                        this.updateAttemptsDisplay();
                    }
                    
                } catch (error) {
                    this.hideLoading();
                    this.showError('Failed to unlock: ' + error.message);
                }
                
                document.getElementById('pin-input').value = '';
            }

            async simulateOpenADPKeyRecovery(pin) {
                this.updateLoadingDetails('📡 Contacting OpenADP servers...');
                await this.delay(300);
                
                this.updateLoadingDetails('🔍 Requesting secret shares...');
                for (let i = 0; i < this.settings.serverThreshold; i++) {
                    this.updateLoadingDetails(`   ✓ Retrieved share from server ${i+1}`);
                    await this.delay(150);
                }
                
                this.updateLoadingDetails('🧩 Reconstructing secret using Lagrange interpolation...');
                await this.delay(200);
                
                this.updateLoadingDetails('🔑 Deriving encryption key from recovered secret...');
                await this.delay(100);
            }

            updateLoadingDetails(message) {
                const detailsElement = document.querySelector('.loading-details .server-status span');
                if (detailsElement) {
                    detailsElement.textContent = message;
                }
            }

            // ... rest of the methods (same as before but with OpenADP branding)
            
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            generateUserID() {
                const array = new Uint8Array(16);
                crypto.getRandomValues(array);
                const hex = Array.from(array, b => b.toString(16).padStart(2, '0')).join('');
                return `${hex.slice(0,8)}-${hex.slice(8,12)}-${hex.slice(12,16)}-${hex.slice(16,20)}-${hex.slice(20,32)}`;
            }

            async validatePIN(pin) {
                const storedHash = localStorage.getItem('openadp_ghost_pin_hash');
                if (!storedHash) {
                    const pinHash = await this.hashPIN(pin);
                    localStorage.setItem('openadp_ghost_pin_hash', pinHash);
                    return true;
                }
                
                const pinHash = await this.hashPIN(pin);
                return pinHash === storedHash;
            }

            async hashPIN(pin) {
                const encoder = new TextEncoder();
                const data = encoder.encode(pin + this.settings.userID);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            }

            async generateSessionKey() {
                const keyMaterial = crypto.getRandomValues(new Uint8Array(32));
                return await crypto.subtle.importKey(
                    'raw',
                    keyMaterial,
                    { name: 'AES-GCM', length: 256 },
                    false,
                    ['encrypt', 'decrypt']
                );
            }

            showLoading(message) {
                const overlay = document.getElementById('loading-overlay');
                const text = overlay.querySelector('.loading-text');
                text.textContent = message;
                overlay.classList.add('active');
            }

            hideLoading() {
                document.getElementById('loading-overlay').classList.remove('active');
            }

            showError(message) {
                document.getElementById('error-message').textContent = message;
                setTimeout(() => {
                    document.getElementById('error-message').textContent = '';
                }, 5000);
            }

            showTemporaryMessage(message) {
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: var(--accent-success);
                    color: white;
                    padding: 0.8rem 1.2rem;
                    border-radius: 8px;
                    z-index: 3000;
                    animation: slideIn 0.3s ease;
                `;
                toast.textContent = message;
                
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }

            setupPWA() {
                console.log('📱 OpenADP Ghost Notes PWA ready');
            }

            // Simplified methods for demo
            async startSession() { this.sessionActive = true; }
            async endSession() { this.sessionActive = false; this.showScreen('login'); }
            createNewNote() { console.log('Creating new OpenADP-protected note...'); }
            async saveCurrentNote() { console.log('Saving note with OpenADP protection...'); }
            async deleteCurrentNote() { console.log('Deleting OpenADP-protected note...'); }
            extendSession() { console.log('Extending OpenADP session...'); }
            updateAttemptsDisplay() { }
            autoSaveNote() { }
        }

        // Initialize the OpenADP-enhanced app
        document.addEventListener('DOMContentLoaded', () => {
            window.openadpGhostNotes = new OpenADPGhostNotes();
        });
    </script>

    <style>
        /* OpenADP-specific styles */
        .openadp-status {
            margin: 1rem 0;
            padding: 1rem;
            background: linear-gradient(135deg, rgba(74, 144, 226, 0.1), rgba(74, 144, 226, 0.05));
            border: 1px solid rgba(74, 144, 226, 0.3);
            border-radius: 8px;
        }

        .openadp-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-success);
            animation: pulse 2s infinite;
        }

        .status-dot.active {
            background: #00ff88;
        }

        .security-level {
            font-size: 0.9rem;
            color: var(--accent-ghost);
        }

        .openadp-info {
            margin-top: 1rem;
        }

        .openadp-info details {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 0.5rem;
        }

        .openadp-info summary {
            cursor: pointer;
            padding: 0.5rem;
            font-weight: bold;
            color: var(--accent-ghost);
        }

        .info-content {
            padding: 1rem;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .info-content ul {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }

        .openadp-setup-info {
            margin: 1rem 0;
        }

        .security-feature {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }

        .feature-icon {
            font-size: 1.5rem;
        }

        .security-feature strong {
            color: var(--accent-ghost);
        }

        .security-feature p {
            margin: 0.25rem 0 0 0;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .openadp-status-mini {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .security-badges {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .badge {
            background: var(--accent-ghost);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .security-indicator {
            color: var(--accent-success);
            font-weight: bold;
        }

        .loading-details {
            margin-top: 1rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .server-status {
            font-family: monospace;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Enhanced form styling for OpenADP */
        .form-group small {
            display: block;
            margin-top: 0.25rem;
            color: var(--accent-ghost);
            font-size: 0.8rem;
        }
    </style>

    <script>
        // Register service worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('👻🔐 OpenADP Service Worker registered:', registration);
                    })
                    .catch(error => {
                        console.log('❌ Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html> 